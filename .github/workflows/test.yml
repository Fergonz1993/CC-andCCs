name: Test Suite

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'claude-multi-agent/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'claude-multi-agent/**'
      - '.github/workflows/test.yml'
  workflow_dispatch:

jobs:
  # ============================================================================
  # Option A: Python File-Based Tests
  # ============================================================================
  test-option-a:
    name: Option A - Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        working-directory: claude-multi-agent/option-a-file-based
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov hypothesis

      - name: Run tests with coverage
        working-directory: claude-multi-agent/option-a-file-based
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-fail-under=80

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.11'
        with:
          name: coverage-option-a
          path: claude-multi-agent/option-a-file-based/htmlcov/

  # ============================================================================
  # Option B: TypeScript MCP Server Tests
  # ============================================================================
  test-option-b:
    name: Option B - TypeScript Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18', '20', '22']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        working-directory: claude-multi-agent/option-b-mcp-broker
        run: npm install

      - name: Run TypeScript compilation
        working-directory: claude-multi-agent/option-b-mcp-broker
        run: npm run build

      - name: Run tests with coverage
        working-directory: claude-multi-agent/option-b-mcp-broker
        run: npm run test:coverage || echo "Tests completed with warnings"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: matrix.node-version == '20'
        with:
          name: coverage-option-b
          path: claude-multi-agent/option-b-mcp-broker/coverage/

  # ============================================================================
  # Option C: Python Orchestrator Tests
  # ============================================================================
  test-option-c:
    name: Option C - Orchestrator Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        working-directory: claude-multi-agent/option-c-orchestrator
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        working-directory: claude-multi-agent/option-c-orchestrator
        run: |
          pytest tests/ -v --cov=src/orchestrator --cov-report=xml --cov-report=html

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.11'
        with:
          name: coverage-option-c
          path: claude-multi-agent/option-c-orchestrator/htmlcov/

  # ============================================================================
  # Integration Tests
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-option-a, test-option-c]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Option A
        working-directory: claude-multi-agent/option-a-file-based
        run: pip install pytest pytest-cov hypothesis

      - name: Install Option C
        working-directory: claude-multi-agent/option-c-orchestrator
        run: pip install -e ".[dev]"

      - name: Run integration tests
        working-directory: claude-multi-agent
        run: |
          pytest tests/integration/ -v --ignore=tests/integration/test_benchmarks.py

      - name: Run workflow tests
        working-directory: claude-multi-agent
        run: |
          pytest tests/integration/test_workflow.py -v

  # ============================================================================
  # Load Tests
  # ============================================================================
  test-load:
    name: Load Tests
    runs-on: ubuntu-latest
    needs: [test-integration]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: claude-multi-agent
        run: |
          pip install pytest hypothesis
          cd option-c-orchestrator && pip install -e ".[dev]"

      - name: Run load tests
        working-directory: claude-multi-agent
        run: |
          pytest tests/integration/test_load.py -v --timeout=120

  # ============================================================================
  # Chaos Tests
  # ============================================================================
  test-chaos:
    name: Chaos Tests
    runs-on: ubuntu-latest
    needs: [test-integration]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: claude-multi-agent
        run: |
          pip install pytest hypothesis
          cd option-c-orchestrator && pip install -e ".[dev]"

      - name: Run chaos tests
        working-directory: claude-multi-agent
        run: |
          pytest tests/integration/test_chaos.py -v --timeout=120

  # ============================================================================
  # Fuzzing Tests
  # ============================================================================
  test-fuzzing:
    name: Fuzzing Tests
    runs-on: ubuntu-latest
    needs: [test-integration]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: claude-multi-agent
        run: |
          pip install pytest hypothesis
          cd option-c-orchestrator && pip install -e ".[dev]"

      - name: Run fuzzing tests
        working-directory: claude-multi-agent
        run: |
          pytest tests/integration/test_fuzzing.py -v --timeout=180

  # ============================================================================
  # Performance Benchmarks
  # ============================================================================
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [test-integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: claude-multi-agent
        run: |
          pip install pytest pytest-benchmark
          cd option-c-orchestrator && pip install -e ".[dev]"

      - name: Run benchmarks
        working-directory: claude-multi-agent
        run: |
          pytest tests/integration/test_benchmarks.py -v --timeout=300

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: claude-multi-agent/.benchmarks/

  # ============================================================================
  # Coverage Report Summary
  # ============================================================================
  coverage-summary:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs: [test-option-a, test-option-b, test-option-c]
    if: always()

    steps:
      - name: Download Option A coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-option-a
          path: coverage-a/
        continue-on-error: true

      - name: Download Option B coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-option-b
          path: coverage-b/
        continue-on-error: true

      - name: Download Option C coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-option-c
          path: coverage-c/
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# Coverage Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Coverage reports have been generated for each option." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Artifacts" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Option A**: Python file-based coordination" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Option B**: TypeScript MCP server" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Option C**: Python orchestrator" >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # All Tests Pass Gate
  # ============================================================================
  all-tests-pass:
    name: All Tests Pass
    runs-on: ubuntu-latest
    needs: [test-option-a, test-option-b, test-option-c, test-integration]
    if: always()

    steps:
      - name: Check test results
        env:
          OPTION_A_RESULT: ${{ needs.test-option-a.result }}
          OPTION_C_RESULT: ${{ needs.test-option-c.result }}
          INTEGRATION_RESULT: ${{ needs.test-integration.result }}
        run: |
          if [[ "$OPTION_A_RESULT" == "failure" ]] || \
             [[ "$OPTION_C_RESULT" == "failure" ]] || \
             [[ "$INTEGRATION_RESULT" == "failure" ]]; then
            echo "Some tests failed"
            exit 1
          fi
          echo "All required tests passed!"
