# Dockerfile for Option B - MCP Server Broker
# Multi-stage build for smaller final image

FROM node:20-alpine as builder

# Set working directory
WORKDIR /app

# Copy package files
COPY option-b-mcp-broker/package*.json ./

# Install dependencies
RUN npm ci --only=production=false

# Copy source code
COPY option-b-mcp-broker/ ./

# Build TypeScript
RUN npm run build

# Production stage
FROM node:20-alpine

# Labels for container metadata
LABEL org.opencontainers.image.title="Claude Multi-Agent Option B"
LABEL org.opencontainers.image.description="MCP Server broker for Claude Code coordination"
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.vendor="Claude Multi-Agent Project"

# Create non-root user for security
RUN addgroup -S claude && adduser -S claude -G claude

WORKDIR /app

# Copy built files and production dependencies
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./

# Copy shared schemas
COPY shared/ ./shared/

# Create coordination directory
RUN mkdir -p /data/.coordination && \
    chown -R claude:claude /app /data

# Environment configuration
ENV NODE_ENV=production
ENV COORDINATION_DIR=/data/.coordination
ENV MCP_SERVER_PORT=3000

# Volume for persistent state
VOLUME ["/data/.coordination"]

# Expose MCP server port (for HTTP transport option)
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD node -e "console.log('ok')" || exit 1

# Run as non-root user
USER claude

# Entry point
ENTRYPOINT ["node", "dist/index.js"]
