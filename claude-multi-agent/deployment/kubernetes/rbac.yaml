# RBAC Configuration for Claude Multi-Agent System
---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: claude-coordinator
  namespace: claude-multiagent
  labels:
    app.kubernetes.io/name: claude-multiagent
    app.kubernetes.io/component: rbac

---
# Role for leader election and coordination
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: claude-coordinator-role
  namespace: claude-multiagent
  labels:
    app.kubernetes.io/name: claude-multiagent
    app.kubernetes.io/component: rbac
rules:
  # Leader election
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "create", "update"]

  # ConfigMaps for configuration
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]

  # Secrets for sensitive data
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]

  # Events for logging
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]

  # Pods for health monitoring
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Services for discovery
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch"]

---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: claude-coordinator-rolebinding
  namespace: claude-multiagent
  labels:
    app.kubernetes.io/name: claude-multiagent
    app.kubernetes.io/component: rbac
subjects:
  - kind: ServiceAccount
    name: claude-coordinator
    namespace: claude-multiagent
roleRef:
  kind: Role
  name: claude-coordinator-role
  apiGroup: rbac.authorization.k8s.io

---
# ClusterRole for cross-namespace operations
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: claude-coordinator-clusterrole
  labels:
    app.kubernetes.io/name: claude-multiagent
    app.kubernetes.io/component: rbac
rules:
  # Nodes for node affinity decisions
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]

  # Custom metrics for autoscaling
  - apiGroups: ["custom.metrics.k8s.io"]
    resources: ["*"]
    verbs: ["get", "list"]

  # External metrics
  - apiGroups: ["external.metrics.k8s.io"]
    resources: ["*"]
    verbs: ["get", "list"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: claude-coordinator-clusterrolebinding
  labels:
    app.kubernetes.io/name: claude-multiagent
    app.kubernetes.io/component: rbac
subjects:
  - kind: ServiceAccount
    name: claude-coordinator
    namespace: claude-multiagent
roleRef:
  kind: ClusterRole
  name: claude-coordinator-clusterrole
  apiGroup: rbac.authorization.k8s.io

---
# Network Policy for pod-to-pod communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: claude-multiagent-network-policy
  namespace: claude-multiagent
  labels:
    app.kubernetes.io/name: claude-multiagent
    app.kubernetes.io/component: security
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: claude-multiagent
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from same namespace
    - from:
        - namespaceSelector:
            matchLabels:
              name: claude-multiagent
    # Allow traffic from Istio ingress gateway
    - from:
        - namespaceSelector:
            matchLabels:
              name: istio-system
    # Allow traffic from monitoring
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
  egress:
    # Allow traffic to same namespace
    - to:
        - namespaceSelector:
            matchLabels:
              name: claude-multiagent
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - port: 53
          protocol: UDP
    # Allow external API access (Claude API)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 443
          protocol: TCP
